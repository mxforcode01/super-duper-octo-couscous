import streamlit as st
from datetime import datetime, date

# Page config
st.set_page_config(
    page_title="Workflow Chatbot",
    page_icon="ü§ñ",
    layout="centered"
)

# Initialize session state variables
if 'messages' not in st.session_state:
    st.session_state.messages = []
    st.session_state.workflow_selected = False
    st.session_state.selected_workflow = None
    st.session_state.dates_collected = False
    st.session_state.data_date = None
    st.session_state.replenishment_date = None
    st.session_state.exclusion_file = None
    st.session_state.update_method_selected = False
    st.session_state.update_method = None
    st.session_state.awaiting_chat_update = False

# Title
st.title("ü§ñ Workflow Assistant")

# Function to add messages to chat
def add_message(role, content):
    st.session_state.messages.append({"role": role, "content": content})

# Main chat container
chat_container = st.container(height=400)

with chat_container:
    # Initial message
    if len(st.session_state.messages) == 0:
        initial_message = "Please choose a workflow:"
        add_message("assistant", initial_message)
    
    # Display all chat messages
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.write(message["content"])
    
    # Step 1: Show workflow buttons if not yet selected
    if not st.session_state.workflow_selected:
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üì¶ Replenishment Workflow", type="primary", use_container_width=True):
                st.session_state.workflow_selected = True
                st.session_state.selected_workflow = "Replenishment"
                add_message("user", "I selected Replenishment Workflow")
                add_message("assistant", "Please provide the following dates:")
                st.rerun()
        
        with col2:
            if st.button("üîÑ Simulation Workflow", type="primary", use_container_width=True):
                st.session_state.workflow_selected = True
                st.session_state.selected_workflow = "Simulation"
                add_message("user", "I selected Simulation Workflow")
                add_message("assistant", "Simulation workflow selected. Processing...")
                st.rerun()
    
    # Step 2: Collect dates for Replenishment workflow
    if st.session_state.selected_workflow == "Replenishment" and not st.session_state.dates_collected:
        with st.form(key="date_form"):
            st.markdown("### Required Dates")
            data_date = st.date_input("Data Date", value=date.today())
            replenishment_date = st.date_input("Replenishment Date", value=date.today())
            
            submit_button = st.form_submit_button("Submit Dates", type="primary", use_container_width=True)
            
            if submit_button:
                st.session_state.data_date = data_date
                st.session_state.replenishment_date = replenishment_date
                st.session_state.dates_collected = True
                add_message("user", f"Data Date: {data_date}, Replenishment Date: {replenishment_date}")
                add_message("assistant", "Dates received. Please upload any manual obligation exclusions:")
                st.rerun()
    
    # Step 3: File upload for exclusions
    if st.session_state.dates_collected and st.session_state.exclusion_file is None:
        uploaded_file = st.file_uploader(
            "Upload manual obligation exclusions",
            type=['csv', 'xlsx', 'txt'],
            key="exclusion_uploader"
        )
        
        if uploaded_file is not None:
            st.session_state.exclusion_file = uploaded_file
            add_message("user", f"Uploaded: {uploaded_file.name}")
            add_message("assistant", "File uploaded successfully. How do you want to update the constraint file?")
            st.rerun()
    
    # Step 4: Show update method buttons
    if st.session_state.exclusion_file and not st.session_state.update_method_selected:
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("‚úèÔ∏è Manual Update", type="secondary", use_container_width=True):
                st.session_state.update_method_selected = True
                st.session_state.update_method = "Manual"
                add_message("user", "Manual Update")
                add_message("assistant", "Manual update selected. Processing constraint file manually...")
                st.rerun()
        
        with col2:
            if st.button("üí¨ Chat Update", type="primary", use_container_width=True):
                st.session_state.update_method_selected = True
                st.session_state.update_method = "Chat"
                st.session_state.awaiting_chat_update = True
                add_message("user", "Chat Update")
                add_message("assistant", "Please say what you are going to update:")
                st.rerun()

# Chat input at the bottom (always visible)
user_input = st.chat_input("Type your message here...")

if user_input:
    # Step 5: Handle chat update instructions
    if st.session_state.awaiting_chat_update:
        add_message("user", user_input)
        add_message("assistant", f"Understood. I will update the constraint file with: '{user_input}'\n\nProcessing update...")
        st.session_state.awaiting_chat_update = False
        
        # Here you would process the actual update
        # For now, just show completion
        with st.spinner("Updating constraint file..."):
            import time
            time.sleep(2)
        
        add_message("assistant", "‚úÖ Constraint file updated successfully with your specifications.")
    else:
        # Handle other general input
        add_message("user", user_input)
        add_message("assistant", f"Received: '{user_input}'")
    
    st.rerun()
